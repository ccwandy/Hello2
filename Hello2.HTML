<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>連續輸入並顯示資料</title>
<style>
:root {
  --bg: #0b0c10; --card: #121319; --muted: #9aa0a6; --text: #e8eaed;
  --accent: #4f46e5; --accent-2: #22c55e; --danger: #ef4444; --border: #23252f;
}
* { box-sizing: border-box; }
body {
  margin: 0; padding: 24px;
  font-family: ui-sans-serif, -apple-system, "Noto Sans TC", Roboto, "Segoe UI", Helvetica, Arial;
  color: var(--text);
  background: radial-gradient(1200px 800px at 20% -10%, #12131a 0, var(--bg) 60%);
}
.container { max-width: 980px; margin: 0 auto; }
.card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
  border: 1px solid var(--border); border-radius: 18px; padding: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
}
h1 { font-size: 28px; margin: 0 0 12px; letter-spacing: 0.5px; }
p.desc { margin: 0 0 16px; color: var(--muted); }
.row { display: flex; gap: 12px; flex-wrap: wrap; }
.grow { flex: 1 1 180px; }
input[type="text"], select {
  width: 100%; padding: 12px 14px; border-radius: 12px;
  border: 1px solid var(--border); outline: none;
  background: #0f1117; color: var(--text); font-size: 16px;
}
input[type="text"]:focus, select:focus {
  border-color: var(--accent); box-shadow: 0 0 0 3px rgba(79,70,229,0.25);
}
button {
  border: 1px solid var(--border); border-radius: 12px; padding: 10px 14px;
  font-size: 14px; cursor: pointer; color: var(--text); background: #151824;
  transition: transform .04s ease, box-shadow .2s ease, background .2s ease;
}
button:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
button:active { transform: translateY(1px); }
.btn-primary { background: linear-gradient(180deg, #3438ff, #2a2edb); border-color: #2b2fe0; }
.btn-secondary { background: #182235; }
.btn-danger { background: linear-gradient(180deg, #ff5a5a, #e23e3e); border-color: #e23e3e; }
.toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
.toolbar .spacer { flex: 1; }
table { width: 100%; border-collapse: collapse; margin-top: 12px; }
thead th { text-align: left; font-weight: 600; color: var(--muted);
  border-bottom: 1px solid var(--border); padding: 10px; }
tbody td { padding: 12px 10px; border-bottom: 1px dashed #1f2330; vertical-align: top; }
tbody tr:hover { background: rgba(255,255,255,0.03); }
.empty { color: var(--muted); text-align: center; padding: 20px; }
</style>
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
<div class="container">
  <div class="card" style="margin-bottom: 16px;">
    <h1>連續輸入並顯示資料</h1>
    <p class="desc">輸入財產編號、流水碼、備註、地點與方式，點「新增」即可加入清單並同步到 Google Sheet。</p>
    <div class="row" style="margin-top: 8px;">
      <div class="grow">
        <label class="desc">QR Code 掃描</label>
        <button id="startScanBtn" class="btn-secondary" type="button">開始掃描</button>
        <label for="zoomSelect" class="desc" style="display:block; margin-top:8px;">放大倍率</label>
        <select id="zoomSelect">
          <option value="1">1倍</option>
          <option value="2">2倍</option>
          <option value="3">3倍</option>
          <option value="4">4倍</option>
        </select>
        <div id="qrReader" style="width:100%; max-width:400px; margin-top:8px; display:none;"></div>
      </div>
      <div class="grow">
        <label class="desc">財產編號</label>
        <input id="propIdInput" type="text" placeholder="Ex：英文字母+6位數字、10位數字" />
      </div>
      <div class="grow">
        <label class="desc">流水碼</label>
        <input id="serialInput" type="text" placeholder="Ex：0001、1" />
      </div>
      <div class="grow">
        <label class="desc">備註</label>
        <input id="noteInput" type="text" placeholder="Ex：工號、人名" />
      </div>
      <div class="grow">
        <label class="desc">地點</label>
        <select id="locationSelect">
          <option value="奇岩">奇岩</option>
          <option value="淡水">淡水</option>
        </select>
      </div>
      <div class="grow">
        <label class="desc">方式</label>
        <select id="methodSelect">
          <option value="送來">送來</option>
          <option value="取回">取回</option>
        </select>
      </div>
    </div>
    <div class="toolbar" style="margin-top: 12px;">
      <button id="addBtn" class="btn-primary" type="button">新增</button>
      <div class="spacer"></div>
      <button id="clearBtn" class="btn-danger" type="button">清除輸入</button>
    </div>
  </div>

  <!-- 資料清單 -->
  <div class="card">
    <div class="row" style="justify-content: space-between; align-items:center; margin-bottom: 6px;">
      <h2 style="margin:0; font-size:20px;">資料清單</h2>
      <div class="desc">共 <span id="count">0</span> 筆</div>
      <button id="clearBtn2" class="btn-danger" type="button" style="margin-left: auto;">清除全部</button>
    </div>
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th style="width: 60px;">序號</th>
            <th>財產編號</th>
            <th>流水碼</th>
            <th>備註</th>
            <th>地點</th>
            <th>方式</th>
            <th style="width: 180px;">時間</th>
            <th style="width: 160px;">操作</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="8" class="empty">目前沒有資料，請從上方輸入新增。</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
// ========== Google Sheet 同步函式 ==========
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxkUrM_BRFTQrxgYkiqZsts8VnbJkeAyImJkfAEgyMtv9Tln-MG1qtOAmBjtrnGy56MyQ/exec";

async function syncToSheet(entry) {
  const body = new URLSearchParams(entry);
  const res = await fetch(GOOGLE_SCRIPT_URL, { method: "POST", body });
  const text = await res.text();
  let data;
  try { data = JSON.parse(text); } catch { data = null; }

  if (!res.ok || !data || data.status !== "success") {
    if (text.startsWith("<")) {
      throw new Error("Web App 沒有設為公開。請在部署時將『誰可以存取』設為「任何人」。");
    }
    throw new Error((data && data.message) || (res.status + " " + res.statusText));
  }
  return data;
}

// ========== 資料清單處理 ==========
let entries = [];

const tbody = document.getElementById("tbody");
const countSpan = document.getElementById("count");
const addBtn = document.getElementById("addBtn");
const propIdInput = document.getElementById("propIdInput");
const serialInput = document.getElementById("serialInput");
const noteInput = document.getElementById("noteInput");
const locationSelect = document.getElementById("locationSelect");
const methodSelect = document.getElementById("methodSelect");
const clearBtn = document.getElementById("clearBtn");
const clearBtn2 = document.getElementById("clearBtn2");

// 渲染表格
function renderTable() {
  tbody.innerHTML = "";
  if (entries.length === 0) {
    tbody.innerHTML = `<tr><td colspan="8" class="empty">目前沒有資料，請從上方輸入新增。</td></tr>`;
  } else {
    entries.forEach((e, idx) => {
      let tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${e.propId}</td>
        <td>${e.serial}</td>
        <td>${e.note}</td>
        <td>${e.location}</td>
        <td>${e.method}</td>
        <td>${e.time}</td>
        <td><button class="btn-danger" onclick="deleteEntry(${idx})">刪除</button></td>
      `;
      tbody.appendChild(tr);
    });
  }
  countSpan.textContent = entries.length;
}

// 新增資料並同步到 Google Sheet
addBtn.addEventListener("click", async () => {
  const propId = propIdInput.value.trim();
  let serial = serialInput.value.trim();
  const note = noteInput.value.trim();
  const location = locationSelect.value;
  const method = methodSelect.value;

  if (!propId || !serial) {
    alert("請至少輸入 財產編號 與 流水碼");
    return;
  }

  // ✅ 固定補滿 4 碼（不足補 0）
  serial = serial.padStart(4, "0");

  const now = new Date();
  const entry = {
    index: entries.length + 1,
    propId,
    serial,
    note,
    location,
    method,
    time: now.toLocaleString("zh-TW")
  };

  entries.push(entry);
  renderTable();

  propIdInput.value = "";
  serialInput.value = "";
  noteInput.value = "";

  try {
    addBtn.disabled = true;
    await syncToSheet(entry);
  } catch (err) {
    console.error(err);
    alert("同步到 Google Sheet 發生錯誤：\n" + err.message);
  } finally {
    addBtn.disabled = false;
  }
});

// 刪除單筆
function deleteEntry(idx) { entries.splice(idx, 1); renderTable(); }
// 清空輸入
clearBtn.addEventListener("click", () => { propIdInput.value=""; serialInput.value=""; noteInput.value=""; });
// 清空全部
clearBtn2.addEventListener("click", () => { if(confirm("確定要清除所有資料嗎？")){ entries=[]; renderTable(); } });

// ========== QR Code 掃描 + 自動解析 + 自動新增 ==========
let qrScanner=null;
let videoTrack=null;
const startScanBtn=document.getElementById('startScanBtn');
const qrReader=document.getElementById('qrReader');
const zoomSelect=document.getElementById('zoomSelect');

async function applyZoom(level){
  if(!videoTrack) return;
  const capabilities=videoTrack.getCapabilities();
  if(capabilities.zoom){
    const min=capabilities.zoom.min, max=capabilities.zoom.max;
    let zoomValue=Math.min(max, Math.max(min, level));
    await videoTrack.applyConstraints({ advanced:[{ zoom: zoomValue }] });
  } else {
    qrReader.style.transform=`scale(${level})`;
  }
}
zoomSelect.addEventListener("change", ()=> applyZoom(parseFloat(zoomSelect.value)));

startScanBtn.addEventListener('click', async ()=>{
  if(qrScanner){
    qrScanner.stop().then(()=>{
      qrScanner.clear(); qrReader.style.display='none'; qrScanner=null; videoTrack=null;
      startScanBtn.textContent='開始掃描';
    });
  } else {
    qrReader.style.display='block';
    qrScanner = new Html5Qrcode("qrReader");
    try {
      await qrScanner.start(
        { facingMode:"environment" },
        { fps:10, qrbox:250 },
        qrCodeMessage=>{
          const patternFull=/^https:\/\/assets\.acbel\.com\/fixed\?data=(\d+)-(\d+)-(\d+)$/;
          const patternPartial=/^https:\/\/assets\.acbel\.com\/fixed\?data=(\d+)$/;
          let parsed=false;

          let matchFull=qrCodeMessage.match(patternFull);
          if(matchFull){
            propIdInput.value = matchFull[2];
            serialInput.value = matchFull[3].slice(0,-1);
            parsed=true;
          } else if(qrCodeMessage.match(patternPartial)){
            let parts=qrCodeMessage.split('-');
            if(parts.length>=3){
              propIdInput.value = parts[1];
              serialInput.value = parts[2].slice(0,-1);
              parsed=true;
            }
          }

          if(parsed){
            // ✅ 只帶入欄位，不自動新增
            alert("掃描成功，資料已帶入輸入框，請確認後再按『新增』。");
          } else {
            alert("掃描成功: " + qrCodeMessage);
          }

          qrScanner.stop().then(()=>{
            qrScanner.clear(); qrReader.style.display='none'; qrScanner=null; videoTrack=null;
            startScanBtn.textContent='開始掃描';
          });
        }
      );
      const stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" } });
      videoTrack=stream.getVideoTracks()[0];
      const capabilities=videoTrack.getCapabilities();
      if(capabilities.focusMode){
        await videoTrack.applyConstraints({ advanced:[{ focusMode:"continuous" }] });
      }
      applyZoom(parseFloat(zoomSelect.value));
      startScanBtn.textContent='停止掃描';
    } catch(err){
      alert("無法啟動相機: "+err);
    }
  }
});
</script>
</body>
</html>
