<script>
// --- QR Code 掃描 ---
let qrScanner = null;
let videoTrack = null; // 儲存相機 track

const startScanBtn = document.getElementById('startScanBtn');
const qrReader = document.getElementById('qrReader');

async function applyZoom(level) {
  if (!videoTrack) return;
  const capabilities = videoTrack.getCapabilities();
  if (capabilities.zoom) {
    const min = capabilities.zoom.min;
    const max = capabilities.zoom.max;
    let zoomValue = Math.min(max, Math.max(min, level));
    await videoTrack.applyConstraints({ advanced: [{ zoom: zoomValue }] });
    console.log("已設定鏡頭縮放倍率:", zoomValue);
  } else {
    console.log("裝置不支援鏡頭縮放");
  }
}

startScanBtn.addEventListener('click', async ()=>{
  if (qrScanner) {
    // 停止掃描
    qrScanner.stop().then(()=>{
      qrScanner.clear(); 
      qrReader.style.display='none'; 
      qrScanner=null;
      videoTrack = null;
      startScanBtn.textContent='開始掃描';
    });
  } else {
    qrReader.style.display='block';
    qrScanner = new Html5Qrcode("qrReader");
    qrScanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      qrCodeMessage => {
        const patternFull = /^https:\/\/assets\.acbel\.com\/fixed\?data=(\d+)-(\d+)-(\d+)$/;
        const patternPartial = /^https:\/\/assets\.acbel\.com\/fixed\?data=(\d+)$/;
        let matchFull = qrCodeMessage.match(patternFull);
        if (matchFull) {
          propIdInput.value = matchFull[2];
          serialInput.value = matchFull[3].slice(0,-1);
          alert("掃描成功，已自動填入財產編號與流水碼");
        } else if (qrCodeMessage.match(patternPartial)) {
          let parts = qrCodeMessage.split('-');
          if (parts.length >= 3) {
            propIdInput.value = parts[1];
            serialInput.value = parts[2].slice(0,-1);
            alert("掃描成功，已自動填入財產編號與流水碼");
          } else {
            alert("掃描成功，但無法解析為財產編號與流水碼");
          }
        } else {
          alert("掃描成功: " + qrCodeMessage);
        }
        qrScanner.stop().then(()=>{
          qrScanner.clear(); qrReader.style.display='none'; qrScanner=null;
          videoTrack = null;
          startScanBtn.textContent='開始掃描';
        });
      }
    ).then(async ()=>{
      startScanBtn.textContent='停止掃描';

      // 取得相機 track
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" }
      });
      videoTrack = stream.getVideoTracks()[0];

      // 啟用自動對焦
      const capabilities = videoTrack.getCapabilities();
      if (capabilities.focusMode) {
        await videoTrack.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
        console.log("已啟用自動對焦");
      }

      // 預設縮放 1 倍
      applyZoom(1);

    }).catch(err=>{
      alert("無法啟動相機: " + err);
    });
  }
});
</script>
